<template>
<div v-if="!vendeg || pictures.length > 0" class="mb-3">

  
  <h1 class="familytree_text">
    Galéria
  </h1>
  <div class="d-flex flex-column justify-content-center align-items-center">
  <input v-if="!vendeg" type="file" multiple class="form-control familytreeinput" @change="SelectImages" accept="image/*" ref="fileInput"> 
  <span id="kepfel" class="familytree_text"> (max 5mb) </span>
</div>
  <div class="text-center">
    <img :src="preview"  class="m-2 previews " alt="thumbnail" v-for="preview in previews">
  </div>
  <div v-if="previews.length!=0 && !vendeg" class="text-center">
    <button  class="btn btn-primary ms-auto mb-3" @click="Upload()">Kép feltöltése</button>
  </div>


  <!-- Gallery -->
  <div id="carouselExampleCaptions" class="carousel slide m-auto" v-if="pictures.length > 0">
    <!-- <div class="carousel-indicators">
      <button v-for="picture, index in pictures" type="button" data-bs-target="#carouselExampleCaptions" :aria-current="{'true' : index==0}" :data-bs-slide-to="index" :class="{'active' : index==0}"></button>
    </div> -->
    <div class="carousel-inner">
      <div v-for="picture, index in pictures" class="carousel-item h-40vw" :class="{'active' : index==0}">
        <a :href="$store.getters.baseURL + '/img/' + picture.Nev" class="h-40vw d-flex flex-column justify-content-center align-items-center" target="_blank">
          <div>
            <img :src="$store.getters.baseURL + '/img/' + picture.Nev" class="m-auto mb-3 pictures" alt="kép">
          </div>
        </a>
        <div class="carousel-caption p-0 d-flex align-items-end justify-content-center">
          <button class="btn btn-sm btn-danger m-2 position-relative" data-bs-target="#carouselExampleCaptions" :data-bs-slide="index+1 == pictures.length ? 'next' : null" @click="Remove(picture)"
            v-if="$store.getters.baseURL + '/img/' + picture.Nev != this.$store.getters.Members[0].profilkep && !vendeg">
            <i class="bi bi-trash"></i>
          </button>
          <button class="btn btn-sm btn-success m-2 position-relative" @click="Download(picture)">
            <i class="bi bi-download"></i>
          </button>
          <button class="btn btn-sm btn-secondary m-2 position-relative" @click="SetProfile(picture)" v-if="!vendeg">
            <i class="bi bi-x-lg" v-if="$store.getters.baseURL + '/img/' + picture.Nev == this.$store.getters.Members[0].profilkep"></i>
            <i class="bi bi-person-bounding-box" v-else></i>
          </button>
        </div>
      </div>
    </div>
    <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleCaptions" data-bs-slide="prev">
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Previous</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleCaptions" data-bs-slide="next">
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Next</span>
    </button>
  </div>

</div>
</template>
<style scoped>

.carousel-caption .btn{
  z-index: 999;
}

h1{
  text-align: center;
  font-family: "Brush Script MT", cursive;
  font-size: 500%;
  margin-bottom: 3vw;
}
.carousel-control-prev, .carousel-control-next{
  background-color: rgba(0, 0, 0, 0.2);
}
.h-40vw{
  height: 40vw;
}

.pictures{
  max-width: 75vw;
  max-height: 40vw;
}
.previews{
  height: 8vh;
  
}
input{
  width: 150px !important;
  margin:0 auto 10px auto;
}
#kepfel{
  font-style: italic;
}


</style>
<script>
import axios from 'axios';


export default{
  props:{
        nodeId:String,
        vendeg:Boolean
    },
  data(){
    return{
      images: [],
      previews: [],
      pictures:[],
      csaladfaID:"",
    }
  },
  created(){
    axios.get(this.$store.getters.baseURL+"/kepek/csaladtagID/" + this.nodeId, {headers: {"authorization": "JWT "+ JSON.parse(sessionStorage.getItem('csaladomemleke'))}})
        .then(res => {
          this.pictures = res.data
          axios.get(this.$store.getters.baseURL + "/csaladtagok/ID/" + this.nodeId, {headers: {"authorization": "JWT "+ JSON.parse(sessionStorage.getItem('csaladomemleke'))}})
          .then(res => {
            this.csaladfaID = res.data[0].csaladfaID;
          })
        })
  },
  methods:{
    SelectImages(e){
      this.previews = [];
      this.images = [];
      for (let i = 0; i < e.target.files.length; i++) {
        if (e.target.files[i].type.includes("image") && e.target.files[i].size < 5242881) {
          this.images.push(e.target.files[i])
          this.AddPreview(e.target.files[i])
        }
      }
    },

    AddPreview(file){
      const reader = new FileReader();
      reader.addEventListener(
        "load",
        () => {
          this.previews.push(reader.result);
        },
        false
      );
  
      if (file) {
        reader.readAsDataURL(file);
      }
    },
    Download(picture){
      var url = '../API/Uploads/' + picture.Nev
      var tmp = document.createElement('A');
      tmp.href = url;
      tmp.download = picture.Nev;
      tmp.click();
    },
    Upload(){
      let data = new FormData();
      for (let i = 0; i < this.images.length; i++) {
        data.append('files', this.images[i]); 
      }
      axios.post(this.$store.getters.baseURL + "/fileUpload", data, {
        headers: {
          "authorization": "JWT "+ JSON.parse(sessionStorage.getItem('csaladomemleke')),
          'Content-Type': 'multipart/form-data'
        }
      })
      .then(res=>{
        this.images.splice(0, this.images.length);
        this.previews.splice(0, this.previews.length);
        this.$refs.fileInput.value = null;
        for (let i = 0; i < res.data.length; i++) {
          let data = {
            csaladtagID: this.nodeId,
            csaladfaID: this.csaladfaID,
            Nev: res.data[i].filename
          }
          axios.post(this.$store.getters.baseURL+"/kepek", data, {headers: {"authorization": "JWT "+ JSON.parse(sessionStorage.getItem('csaladomemleke'))}})
          .then(res=>{
            data.ID = res.data.insertId;
            this.pictures.push(data);
          })
        }
      })
    },
    Remove(picture){
      axios.delete(this.$store.getters.baseURL + "/fileDelete/kepek/ID/" + picture.ID, {headers: {"authorization": "JWT "+ JSON.parse(sessionStorage.getItem('csaladomemleke'))}})
      .then(res =>{
        axios.delete(this.$store.getters.baseURL + "/kepek/ID/" + picture.ID, {headers: {"authorization": "JWT "+ JSON.parse(sessionStorage.getItem('csaladomemleke'))}})
        .then(res=>{
          this.pictures.splice(this.pictures.findIndex(x => x.ID == picture.ID), 1);
          if (this.$store.getters.baseURL + '/img/' + picture.Nev == this.$store.getters.Members[0].profilkep) {
            let data ={
              profilkep: ""
            }
            axios.patch(this.$store.getters.baseURL + "/csaladtagok/" + this.nodeId, data, {headers: {"authorization": "JWT "+ JSON.parse(sessionStorage.getItem('csaladomemleke'))}})
            .then(res => {
              let node = this.$store.getters.Members[0]
              node.profilkep = null;
              this.$store.commit('UpdateNode', node);
            })
          }
        })
      })
    },
    SetProfile(picture){
      let data={};
      if (this.$store.getters.baseURL + '/img/' + picture.Nev == this.$store.getters.Members[0].profilkep) {
        data.profilkep = "";
      } else {
        data.profilkep= picture.Nev
      }
      axios.patch(this.$store.getters.baseURL + "/csaladtagok/" + this.nodeId, data, {headers: {"authorization": "JWT "+ JSON.parse(sessionStorage.getItem('csaladomemleke'))}})
      .then(res => {
        let node = this.$store.getters.Members[0]
        node.profilkep = data.profilkep != "" ? this.$store.getters.baseURL + "/img/" + data.profilkep : null;
        this.$store.commit('UpdateNode', node);
      })
    },
  }
}
</script>
